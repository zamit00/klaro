<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>בדיקת שירות mislaka-service</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Varela+Round&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<script src="mainscript.js"></script>
<script src="kochavimscript.js"></script>
<script src="data.js"></script>


<style>
:root {
--primary: #0A2540;
--accent: #F37253;
--bg: #F4F6F8;
--card: #ffffff;
--muted: #6b7280;
--success: #10b981;
--border: #e5e7eb;
}

* {
box-sizing: border-box;
}

body {
margin: 0;
background: var(--bg);
color: var(--primary);
font-family: 'Varela Round', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
line-height: 1.6;
}

header {
background: linear-gradient(135deg, var(--primary) 0%, #1a365d 100%);
color: #fff;
padding: 16px 20px;
font-weight: 700;
font-family: 'Montserrat', sans-serif;
letter-spacing: .3px;
box-shadow: 0 4px 20px rgba(10, 37, 64, .15);
}

.container {
max-width: 1200px;
margin: 24px auto;
padding: 0 16px;
width: 100%;
box-sizing: border-box;
}

.card {
background: var(--card);
border-radius: 14px;
box-shadow: 0 6px 20px rgba(10, 37, 64, .06);
padding: 24px;
margin-bottom: 20px;
transition: box-shadow 0.3s ease;
}

.card:hover {
box-shadow: 0 8px 25px rgba(10, 37, 64, .1);
}

h1 {
font-family: 'Montserrat', sans-serif;
font-size: 22px;
margin: 0 0 8px;
background: linear-gradient(135deg, var(--primary), var(--accent));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}

h2 {
font-family: 'Montserrat', sans-serif;
font-size: 18px;
margin: 20px 0 15px;
color: var(--primary);
}

.muted {
color: var(--muted);
margin: 0 0 20px;
}

.row {
display: flex;
gap: 12px;
flex-wrap: wrap;
align-items: center;
}

  .product-select-container {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
 
  select {
    flex: 1 1 260px;
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background: var(--card);
    color: var(--primary);
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>');
    background-repeat: no-repeat;
    background-position: left 10px center;
    padding-left: 40px;
    direction: rtl;
  }

input[type="text"] {
flex: 1 1 260px;
padding: 12px 14px;
border: 2px solid var(--border);
border-radius: 10px;
font-size: 16px;
outline: none;
transition: border-color 0.3s ease, box-shadow 0.3s ease;
background: var(--card);
}

input[type="text"]:focus, select:focus {
border-color: var(--accent);
box-shadow: 0 0 0 3px rgba(243, 114, 83, 0.1);
}

button {
background: linear-gradient(135deg, var(--accent) 0%, #e85a3b 100%);
color: #fff;
border: none;
border-radius: 10px;
padding: 12px 18px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s ease;
box-shadow: 0 2px 10px rgba(243, 114, 83, 0.3);
}

button:hover {
transform: translateY(-1px);
box-shadow: 0 4px 15px rgba(243, 114, 83, 0.4);
}

.status {
margin-top: 12px;
font-size: 14px;
color: var(--muted);
}

pre {
background: #0f172a;
color: #e5e7eb;
padding: 16px;
border-radius: 12px;
overflow: auto;
font-size: 13px;
line-height: 1.5;
direction: ltr;
text-align: left;
border: 1px solid rgba(255, 255, 255, .06);
}

.hidden {
display: none;
}

.spinner {
width: 18px;
height: 18px;
border: 3px solid #ffffff70;
border-top-color: #fff;
border-radius: 50%;
display: inline-block;
vertical-align: middle;
animation: spin 1s linear infinite;
margin-inline-start: 8px;
}

@keyframes spin {
to {
 transform: rotate(360deg);
}
}

.chip {
display: inline-block;
background: #eef2f7;
color: #334155;
padding: 6px 10px;
border-radius: 999px;
font-size: 12px;
margin-inline-start: 6px;
font-weight: 500;
}

/* עיצוב טבלה מעוצבת */
.table-container {
overflow-x: auto;
margin: 20px 0;
border-radius: 12px;
box-shadow: 0 4px 15px rgba(10, 37, 64, 0.08);
background: var(--card);
}

.styled-table {
width: 100%;
border-collapse: collapse;
font-size: 15px;
min-width: 400px;
}

.styled-table thead tr {
background: linear-gradient(135deg, var(--primary) 0%, #1a365d 100%);
color: white;
text-align: center;
font-weight: 700;
font-family: 'Montserrat', sans-serif;
}

.styled-table th, .styled-table td {
padding: 15px 20px;
border-bottom: 1px solid var(--border);
}

.styled-table th {
font-size: 14px;
letter-spacing: 0.5px;
text-transform: uppercase;
position: relative;
}

.styled-table tbody tr {
transition: all 0.3s ease;
}

.styled-table tbody tr:nth-child(even) {
background: rgba(10, 37, 64, 0.02);
}

.styled-table tbody tr:hover {
background: rgba(243, 114, 83, 0.05);
transform: scale(1.01);
box-shadow: 0 2px 10px rgba(10, 37, 64, 0.1);
cursor: pointer;
}

.styled-table td {
font-weight: 500;
}

.styled-table .amount {
color: var(--success);
font-weight: 700;
font-size: 16px;
text-align: left;
}

/* מחזיק הגרף */
.chart-container {
position: relative;
width: 100%;
max-width: 100%;
margin: 0 auto;
background: var(--card);
border-radius: 14px;
padding: 20px;
box-shadow: 0 6px 20px rgba(10, 37, 64, .06);
box-sizing: border-box;
}

.chart-wrapper {
position: relative;
height: 350px;
}

/* סך הכל מעוצב */
.total-summary {
background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
color: white;
text-align: center;
padding: 15px 20px;
border-radius: 12px;
margin: 20px 0;
box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.total-amount {
font-size: 28px;
font-weight: 700;
font-family: 'Montserrat', sans-serif;
margin: 5px 0;
}

.total-summary p {
margin: 0;
font-size: 16px;
font-weight: 500;
}

/* מקרא */
.legend-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 12px;
margin-top: 20px;
padding: 15px;
background: rgba(10, 37, 64, 0.02);
border-radius: 10px;
}

.legend-item {
display: flex;
align-items: center;
gap: 10px;
padding: 8px 12px;
background: var(--card);
border-radius: 8px;
box-shadow: 0 2px 8px rgba(10, 37, 64, 0.05);
transition: transform 0.2s ease;
}

.legend-item:hover {
transform: translateY(-2px);
}

.legend-color {
width: 16px;
height: 16px;
border-radius: 50%;
flex-shrink: 0;
}

.legend-text {
font-size: 13px;
font-weight: 500;
line-height: 1.3;
}

.legend-amount {
color: var(--success);
font-weight: 700;
margin-right: auto;
font-size: 14px;
}

/* גרידת תוצאות */
.results-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin-top: 20px;
}
#backButton {
background: #6b7280;
box-shadow: none;
font-size: 14px;
padding: 8px 16px;
}

#backButton:hover {
background: #4b5563;
}

  .details-selector {
    padding: 24px;
    background: var(--card);
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(10, 37, 64, .06);
    margin-bottom: 20px;
  }

/* רספונסיביות משופרת */
@media (max-width: 1024px) {
.results-grid {
 grid-template-columns: 1fr;
}
}

@media (max-width: 768px) {
  .msllTable{
    margin-right: 10%;margin-left: 10%;width: 80%;
  }
  
.container {
 padding: 0 8px;
 width: 100%;
 margin: 12px auto;
}
.card {
 padding: 16px;
 margin-bottom: 15px;
 border-radius: 10px;
}
.chart-container {
 max-width: 100%;
 padding: 15px;
 margin: 0;
}
.chart-wrapper {
 height: 280px;
}
.legend-grid {
 grid-template-columns: 1fr;
 padding: 10px;
 gap: 8px;
}
.legend-item {
 padding: 6px 10px;
 font-size: 12px;
}
.legend-text {
 font-size: 12px;
}
.legend-amount {
 font-size: 13px;
}
.row {
 flex-direction: column;
 align-items: stretch;
 gap: 8px;
}
input[type="text"] {
 flex: 1;
 padding: 10px 12px;
 font-size: 16px;
}
button {
 padding: 10px 16px;
 width: 100%;
}
.styled-table th, .styled-table td {
 padding: 8px 10px;
 font-size: 14px;
}
.styled-table .amount {
 font-size: 14px;
}
h1 {
 font-size: 18px;
}
h2 {
 font-size: 16px;
 margin: 15px 0 10px;
}
.total-amount {
 font-size: 24px;
}
.total-summary {
 padding: 12px 16px;
}
}

@media (max-width: 480px) {
.container {
 padding: 0 4px;
}
.card {
 padding: 12px;
}
.chart-wrapper {
 height: 250px;
}
.styled-table th, .styled-table td {
 padding: 6px 8px;
 font-size: 13px;
}
.total-amount {
 font-size: 20px;
}
.legend-text {
 font-size: 11px;
}
.legend-amount {
 font-size: 12px;
}
}

/* מניעת גלילה אופקית */
body {
overflow-x: hidden;
}

.container {
width: 100%;
box-sizing: border-box;
}

.table-container {
margin: 15px 0;
max-width: 100%;
}

.styled-table {
min-width: 300px;
font-size: 14px;
}

.detail-card h4 {
 font-size: 15px;
 margin: 10px 0 5px;
 color: var(--primary);
}

.detail-card ul {
 margin: 0;
 padding-right: 20px;
}

.detail-card li {
 margin-bottom: 5px;
 font-size: 14px;
}

.detail-card li strong {
 font-weight: 700;
}
.tblMas {
      border-collapse: collapse;
      width: 100%;
      max-width: 1000px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
   .tblMas thead {
      background-color:orangered;
      color: #fff;
    }

   .tblMas th, .tblMas td {
      padding: 14px 16px;
      text-align: center;
    }

   .tblMas tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

   .tblMas tbody tr:hover {
      background-color: #eef6ff;
    }

    .tblMas td.positive {
      color: #4caf50;
      font-weight: bold;
    }

    .tblMas td.zero {
      color: #999;
      font-style: italic;
    }

</style>
</head>
<body>
<header style="font-size: 1.8rem;text-align: center;">פיננסינט – מידע פנסיוני ללקוח</header>
<div class="container">
<div class="card">
<h1>קריאה לשירות ברשת לפי תז</h1>
<p class="muted">הזן תעודת זהות ולחץ "שלח בקשה"</p>

<div class="row">
<label for="mispar" class="chip">מספר ת"ז</label>
<input id="mispar" type="text" value="" inputmode="numeric" autocomplete="off" />
<button id="btn">שלח בקשה</button>
</div>

<div id="status" class="status"></div>
</div>

<div id="resultsContainer" class="hidden">

<div class="total-summary">
<div>סכום כולל צבור</div>
<div id="totals" class="total-amount">0 ש״ח</div>
</div>

<div class="results-grid">
<div class="card">
<h2>פירוט לפי סוג מוצר</h2>
<div class="table-container">
<table class="styled-table">
<thead>
<tr>
<th>שם המוצר</th>
<th>סכום צבור</th>
</tr>
</thead>
<tbody id="productTable"></tbody>
</table>
</div>
</div>

<div class="card">
<h2>התפלגות החיסכון</h2>
<div class="chart-container">
<div class="chart-wrapper">
<canvas id="pieChart"></canvas>
</div>
</div>
</div>
</div>

<div class="card">
<h2>מקרא</h2>
<div id="legend" class="legend-grid"></div>
</div>
<div class="card">
<h2>תוצאה מלאה (JSON)</h2>
<pre id="output">// התוצאה תופיע כאן</pre>
</div>

</div>
</div>

<div id="detailsContainer" class="hidden">
<div class="card details-selector-card">
 <div class="row" style="align-items: center; justify-content: space-between;">
 <h2 id="detailsTitle">פירוט חשבונות - [שם המוצר]</h2>
 <button id="backButton">חזרה</button>
 </div>

 <div class="details-selector">
 <h3>בחר מוצר לצפייה בפרטים:</h3>
 <div class="product-select-container">
  <select id="productSelector">
  <option value="">בחר סוג מוצר...</option>
  </select>
  <button id="showProductDetailsBtn">הצג פרטים</button>
 </div>
 </div>

 <div id="accountDetails">
  </div>
</div>
</div>

</div>

<script>
const endpointBase = "https://mislaka-service-742661432038.europe-west4.run.app/get-by-id";
const btn = document.getElementById('btn');
const misparInput = document.getElementById('mispar');
const out = document.getElementById('output');
const statusEl = document.getElementById('status');
const resultsContainer = document.getElementById('resultsContainer');
let pieChart = null;
const detailsContainer = document.getElementById('detailsContainer');
const backButton = document.getElementById('backButton');
const accountDetails = document.getElementById('accountDetails');
const detailsTitle = document.getElementById('detailsTitle');
const productSelector = document.getElementById('productSelector');
const showProductDetailsBtn = document.getElementById('showProductDetailsBtn');
let dataJason;

// שמירת הנתונים הגולמיים במשתנה גלובלי
let rawData = null; 


// צבעים יפים לגרף
const chartColors = [
'#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
'#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
];

// מיפוי קוד → שם סוג המוצר
const sugTochnitOHeshbon = {
1: "פוליסת ביטוח חיים משולב חיסכון",
2: "קרן פנסיה",
3: "קופת גמל",
4: "קרן השתלמות",
5: "פוליסת חיסכון טהור",
6: "פוליסת סיכון טהור (ריסק מוות ו/או פוליסת אכ״ע SA)",
7: "ביטוח חיים משכנתא",
8: "פוליסת סיכון טהור קולקטיב",
9: "קופת גמל להשקעה",
10: "חיסכון לכל ילד"
};

function setStatus(msg, loading=false){
statusEl.innerHTML = loading ? `${msg} <span class="spinner"></span>` : msg;
}

function formatNumber(num) {
if (num === null || num === undefined) {
return 'אין נתון';
}
return new Intl.NumberFormat('he-IL').format(Math.round(num));
}

function createPieChart(data) {
const ctx = document.getElementById('pieChart').getContext('2d');

if (pieChart) {
pieChart.destroy();
}

const labels = [];
const amounts = [];
const colors = [];

Object.entries(data).forEach(([type, amount], index) => {
labels.push(sugTochnitOHeshbon[type] || `סוג ${type}`);
amounts.push(amount);
colors.push(chartColors[index % chartColors.length]);
});

pieChart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: labels,
datasets: [{
data: amounts,
backgroundColor: colors,
borderColor: '#ffffff',
borderWidth: 3,
hoverBorderWidth: 4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false
},
tooltip: {
backgroundColor: 'rgba(10,37,64,0.9)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: '#F37253',
borderWidth: 1,
cornerRadius: 8,
displayColors: true,
callbacks: {
label: function(context) {
const percentage = ((context.parsed / amounts.reduce((a,b) => a+b, 0)) * 100).toFixed(1);
return `${context.label}: ${formatNumber(context.parsed)} ש״ח (${percentage}%)`;
}
}
}
},
cutout: '50%',
animation: {
animateRotate: true,
duration: 1500
}
}
});
}

function createLegend(data) {
const legendContainer = document.getElementById('legend');
legendContainer.innerHTML = '';

Object.entries(data).forEach(([type, amount], index) => {
const legendItem = document.createElement('div');
legendItem.className = 'legend-item';

const color = chartColors[index % chartColors.length];
const productName = sugTochnitOHeshbon[type] || `סוג ${type}`;

legendItem.innerHTML = `
<div class="legend-color" style="background-color: ${color}"></div>
<div class="legend-text">${productName}</div>
<div class="legend-amount">${formatNumber(amount)} ש״ח</div>
`;

legendContainer.appendChild(legendItem);
});
}

function show(data) {
rawData = data;
out.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);

if (!data?.matches || !Array.isArray(data.matches) || data.matches.length === 0) {
 setStatus('אין נתונים זמינים עבור תעודת הזהות שהוזנה.');
 resultsContainer.classList.add('hidden');
 return;
}

const tbody = document.getElementById("productTable");
tbody.innerHTML = '';

const totalsByType = {};
let totalSum = 0;

data.matches.forEach(level1 => {
 level1.forEach(yatzran => {
 if (yatzran.heshbonColl && Array.isArray(yatzran.heshbonColl)) {
  yatzran.heshbonColl.forEach(heshbonItem => {
  const type = heshbonItem.sugMutzar;
  if (heshbonItem.taktziv && Array.isArray(heshbonItem.taktziv)) {
   heshbonItem.taktziv.forEach(taktzivItem => {
   if (taktzivItem.yitrot && Array.isArray(taktzivItem.yitrot)) {
    taktzivItem.yitrot.forEach(yitraItem => {
    // מבנה חדש, צריך לגשת דרך yitrot
    const amount = parseFloat(yitraItem?.yitrot?.totalErkeyPidion) || 0;
    if (type) {
     totalsByType[type] = (totalsByType[type] || 0) + amount;
     totalSum += amount;
    }
    });
   }
   });
  }
  });
 }
 });
});

Object.entries(totalsByType).forEach(([type, total]) => {
 if (total > 0) {
 const row = document.createElement("tr");
 row.innerHTML = `
 <td>${sugTochnitOHeshbon[type] || `סוג ${type}`}</td>
 <td class="amount">${formatNumber(total)} ש״ח</td>
 `;
 row.addEventListener('click', () => {
 showDetails(type);
 });
 tbody.appendChild(row);
 }
});

updateProductSelector(totalsByType);
document.getElementById("totals").textContent = `${formatNumber(totalSum)} ש״ח`;
createPieChart(totalsByType);
createLegend(totalsByType);
resultsContainer.classList.remove('hidden');
}

function updateProductSelector(totals) {
 productSelector.innerHTML = '<option value="">בחר סוג מוצר...</option>';
 Object.keys(totals).forEach(type => {
  const option = document.createElement('option');
  option.value = type;
  option.textContent = sugTochnitOHeshbon[type] || `סוג ${type}`;
  productSelector.appendChild(option);
 });
}

function showDetailsFromSelector() {
 const selectedType = productSelector.value;
 if (selectedType) {
  showDetails(selectedType);
 }
}


btn.addEventListener('click', async () => {
const mispar = misparInput.value.trim();
if(!mispar || mispar.length < 8 ){
setStatus('❗ יש להזין מספר ת״ז תקין');
return;
}

const url = `${endpointBase}?mispar=${encodeURIComponent(mispar)}`;
setStatus('מבצע קריאה לשירות…', true);
resultsContainer.classList.add('hidden');
detailsContainer.classList.add('hidden');

try{
const res = await fetch(url, { method:'GET' });
if(!res.ok){
const text = await res.text();
setStatus(`שגיאה מהשרת (HTTP ${res.status})`);
out.textContent = text;
resultsContainer.classList.remove('hidden');
return;
}
const json = await res.json();
setStatus('הצלחה ✅');
dataJason=json;
show(json);
}catch(err){
setStatus('שגיאה בביצוע הבקשה מהדפדפן');
out.textContent = String(err);
resultsContainer.classList.remove('hidden');
}
});

misparInput.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
btn.click();
}
});
function showDetails(productType) {
  
    const titleText = sugTochnitOHeshbon[productType] || `סוג ${productType}`;
    detailsTitle.textContent = `פירוט חשבונות - ${titleText}`;
    accountDetails.innerHTML = '';

    const getMaasikName = (yatzran, mispar) => {
        shemYatzranA=yatzran.shemYatzran;
        const maasik = yatzran.maasikimColl?.find(m => String(m.misparMaasikBeYatzranR) === String(mispar));
        if (maasik?.shemMaasik && typeof maasik.shemMaasik === 'object' && maasik.shemMaasik['$']) {
            return '';
        }
        return maasik?.shemMaasik || 'לא ידוע';
    };

    rawData.matches.forEach(level1 => {
        level1.forEach(yatzran => {
            const sugKvetz = yatzran.sugKvetz || '';
            if (yatzran.heshbonColl && Array.isArray(yatzran.heshbonColl)) {
                heshbonItem: for (const heshbonItem of yatzran.heshbonColl) {
                    if (String(heshbonItem.sugMutzar) !== String(productType)) {
                        continue heshbonItem;
                    }

                    const aggregatedMaslulimInHeshbon = {};
                    let maasikName = '';
                    let hasMaslulim = false;
                    
                    let unifiedFeeHisachon = null;
                    let unifiedFeeHafkada = null;

                    if (heshbonItem.taktziv && Array.isArray(heshbonItem.taktziv)) {
                        heshbonItem.taktziv.forEach(t => {
                            
                            const activeMaasik = t.maasikimM?.find(m => m.statusMaasik === '1');
                            const maasikMispar = activeMaasik?.misparMaasikBeYatzranM;
                            
                            if (maasikMispar) {
                                maasikName = getMaasikName(yatzran, maasikMispar);
                            }

                            if (t.dmeinihul && Array.isArray(t.dmeinihul)) {
                                const hisachonFee = t.dmeinihul.find(f => f.dmeiNihulAchidim === '1' && f.sugHotzaa === '1');
                                const hafkadaFee = t.dmeinihul.find(f => f.dmeiNihulAchidim === '1' && f.sugHotzaa === '2');
                                
                                if (hisachonFee) {
                                    unifiedFeeHisachon = hisachonFee.sheurDmeiNihul;
                                }
                                if (hafkadaFee) {
                                    unifiedFeeHafkada = hafkadaFee.sheurDmeiNihul;
                                }
                            }

                            if (t.maslulim && Array.isArray(t.maslulim)) {
                                t.maslulim.forEach(m => {
                                    const maslul = m.maslul;
                                    const amount = parseFloat(maslul?.schumZviraBeMaslul) || 0;
                                    
                                    if (maslul?.kodMaslul && amount > 0) {
                                        
                                        const kod = maslul.kodMaslul;
                                        const msl= maslulim(kod);
                                        const msla=detectMaslulFromShemKupa(msl.shemkupa);
                                        console.log(msla);return;
                                        const dmeiNihulHisachon = unifiedFeeHisachon !== null ? `${unifiedFeeHisachon}%` : (maslul.sheurDmeiNihulHisachon != null ? `${maslul.sheurDmeiNihulHisachon}%` : '0%');
                                        const dmeiNihulHafkada = unifiedFeeHafkada !== null ? `${unifiedFeeHafkada}%` : (maslul.sheurDmeiNihulHafkada != null ? `${maslul.sheurDmeiNihulHafkada}%` : '0%');
                                        
                                        if (!aggregatedMaslulimInHeshbon[kod]) {
                                            aggregatedMaslulimInHeshbon[kod] = {
                                                shem: maslul.shemMaslulHashkaa,
                                                schumZvira: 0,
                                                dmeiNihulHisachon,
                                                dmeiNihulHafkada,
                                                kodMaslul:maslul.kodMaslul

                                            };
                                        }
                                        aggregatedMaslulimInHeshbon[kod].schumZvira += amount;
                                        hasMaslulim = true;
                                    }
                                });
                            }
                        });
                    }

                    if (!hasMaslulim && (!heshbonItem.prisha || heshbonItem.prisha.length === 0)) {
                        continue;
                    }

                    const heshbonCard = document.createElement('div');
                    heshbonCard.className = 'card detail-card';
                    heshbonCard.style.boxShadow = '5px 10px 10px  rgba(0, 0, 0, 0.2)';
                    heshbonCard.style.maxWidth = '600px';
                    heshbonCard.style.marginLeft = 'auto';
                    heshbonCard.style.marginRight = 'auto';

                if(sugKvetz !== 'קרנות פנסיה ותיקות') {
                        
                   
                    var taktzivHtml = Object.keys(aggregatedMaslulimInHeshbon).map(kod => {
                        const maslulData = aggregatedMaslulimInHeshbon[kod];
                        return `
                            <li>                                
                                  <p>מספר באוצר: ${parseInt(maslulData.kodMaslul.slice(23))}</p> 
                                  <strong>${maslulData.shem}</strong><br>
                                  סכום צבור: ${formatNumber(maslulData.schumZvira)} ש״ח<br>
                                  דמי ניהול מחיסכון: ${maslulData.dmeiNihulHisachon} | מהפקדה: ${maslulData.dmeiNihulHafkada}
                            </li>
                        `;
                    }).join('');
                  }
                    else {
                      
                     

                      // פונקציית סינון שמחזירה רק את האובייקטים הרצויים
                      const filteredData = dataJason.matches.filter(item => {
                          // מכיוון שהמבנה הוא מערך בתוך מערך, נבדוק את האובייקט הראשון במערך הפנימי
                          return item[0] && item[0].sugKvetz === 'קרנות פנסיה ותיקות'
                          ;
                      });
                    
                   
                    let amountsum = 0;

                    // נתחיל בלולאה על הנתונים במשתנה amount
                    filteredData.forEach(level1 => {
                      level1.forEach(yatzran => {
                        // בודקים אם קיים מערך של חשבונות
                        if (yatzran.heshbonColl && Array.isArray(yatzran.heshbonColl)) {
                          yatzran.heshbonColl.forEach(heshbon => {
                            // בודקים אם קיים מערך של תקציבים
                            if (heshbon.taktziv && Array.isArray(heshbon.taktziv)) {
                              heshbon.taktziv.forEach(taktzivItem => {
                                // בודקים אם קיים מערך של מסלולים
                                if (taktzivItem.maslulim && Array.isArray(taktzivItem.maslulim)) {
                                  taktzivItem.maslulim.forEach(maslulItem => {
                                    const maslulAmount = parseFloat(maslulItem?.maslul?.schumZviraBeMaslul);
                                    // מוסיפים את הסכום אם הוא מספר חוקי
                                    if (!isNaN(maslulAmount)) {
                                      amountsum += maslulAmount;
                                    }
                                  });
                                }
                              });
                            }
                          });
                        }
                      });
                    });

                  
                    
                    
                  
                
                    var taktzivHtml=`
                           <li>
                                <strong>${"כללי"}</strong><br>
                               סכום צבור: ${formatNumber(amountsum)} ש״ח<br>
                              דמי ניהול מחיסכון: ${0} | מהפקדה: ${0}
                          </li>                        `;
                  }
                     
                  totalSum = 0;
                  
                    
                    const maasikSection = maasikName ? `<p style="color:blue"><strong>מעסיק:</strong> ${maasikName}</p>` : '';

                    let prishaHtml = '';
                    if (heshbonItem.prisha && Array.isArray(heshbonItem.prisha) && heshbonItem.prisha.length > 0 && sugKvetz !=='קרנות פנסיה ותיקות') {
                        prishaHtml = heshbonItem.prisha.map(p => {
                            const hisachonTzafoi = p.hisachonMitztaberTzafoi != null ? formatNumber(p.hisachonMitztaberTzafoi) : 'אין נתון';
                            const hisachonTzafoiLelo = p.hisachonMitztaberTzafoiLelo != null ? formatNumber(p.hisachonMitztaberTzafoiLelo) : 'אין נתון';
                            const gilPrisha = p.gilPrisha != null ? p.gilPrisha : 'אין נתון';
                            
                            return `
                                <h4>יתרות לפרישה (גיל ${Math.round(gilPrisha)}):</h4>
                                <ul>
                                    <li>חיסכון מצטבר צפוי: ${hisachonTzafoi} ש״ח</li>
                                    <li>חיסכון מצטבר צפוי (ללא תוספות): ${hisachonTzafoiLelo} ש״ח</li>
                                </ul>
                            `;
                        }).join('');
                    }
                    
                    const taarich = heshbonItem.taarichHitztarfutMutzar;
                    const formattedDate = (taarich && typeof taarich === 'string' && taarich.length === 8) ? `${taarich.slice(6)}/${taarich.slice(4,6)}/${taarich.slice(0,4)}` : 'אין נתון';

                    // תיקון: הוספת "קרנות פנסיה חדשות" לתנאי ה-if
                    if((sugKvetz === 'קופות גמל' || sugKvetz === 'פוליסות ביטוח פרט' ||
                         sugKvetz === 'קרנות פנסיה חדשות' || sugKvetz === 'קרנות פנסיה ותיקות') 
                        && taktzivHtml) {
                        heshbonCard.innerHTML = `
                            <h3>${yatzran.shemYatzran} - ${heshbonItem.shemTochnit}</h3>
                            <p><strong>מספר חשבון:</strong> ${heshbonItem.misparHeshbon}</p>
                            <p><strong>תשואה נטו:</strong> ${heshbonItem.sheurTesuaNeto != null ? `${heshbonItem.sheurTesuaNeto}%` : 'אין נתון'}</p>
                            <p><strong>תאריך הצטרפות:</strong> ${formattedDate}</p>
                            ${maasikSection}  
                            ${taktzivHtml ? `<h4>מסלולי השקעה:</h4><ul>${taktzivHtml}</ul>` : ''}                            
                             ${prishaHtml}
                        `;
                        taktzivHtml='';
                    } 
                    else {
                        const shemMaslulHabituah = heshbonItem.shemMaslulHabituah && (heshbonItem.shemMaslulHabituah.$ && (heshbonItem.shemMaslulHabituah['$']))
                            ? 'אין נתון'
                            : heshbonItem.shemMaslulHabituah || 'אין נתון';
                        if(taktzivHtml){
                        heshbonCard.innerHTML = `
                            <h3>${yatzran.shemYatzran} - ${heshbonItem.shemTochnit}</h3>
                            <p><strong>מספר חשבון:</strong> ${heshbonItem.misparHeshbon}</p>
                            <p><strong>תשואה נטו:</strong> ${heshbonItem.sheurTesuaNeto != null ? `${heshbonItem.sheurTesuaNeto}%` : 'אין נתון'}</p>
                            <p><strong>תאריך הצטרפות:</strong> ${formattedDate}</p>
                            <p><strong>מסלול ביטוח:</strong> ${shemMaslulHabituah}</p>
                            ${maasikSection}
                            ${taktzivHtml ? `<h4>מסלולי השקעה:</h4><ul>${taktzivHtml}</ul>` : ''}
                            ${prishaHtml}
                        `;
                        taktzivHtml='';
                        }
                    }
                    
                    accountDetails.appendChild(heshbonCard);
                }
            }
        });
    });

    resultsContainer.classList.add('hidden');
    detailsContainer.classList.remove('hidden');
}

backButton.addEventListener('click', () => {
detailsContainer.classList.add('hidden');
resultsContainer.classList.remove('hidden');
});

showProductDetailsBtn.addEventListener('click', showDetailsFromSelector);
</script>
</body>
</html>
